package com.test.sku.network;

import java.io.*;
import java.net.*;
import java.util.*;

public class ChatThread extends Thread {
	private Socket s;
	private ObjectInputStream ois;
	private ObjectOutputStream oos;
	
	static Map<String, ObjectOutputStream> user = new HashMap<>();
	
	public ChatThread() { }
	public ChatThread(Socket s, ObjectInputStream ois, ObjectOutputStream oos) {
		this.s = s;
		this.ois = ois;
		this.oos = oos;

		ChatMsg cm = new ChatMsg("서버", "클라이언트", "로그인 성공");
		
		try {
			oos.writeObject(cm);
			oos.flush();
		} catch (IOException e) {
			e.printStackTrace();
		}
	}

	@Override
	public void run() {
		try {
			while(true) {
				ChatMsg cm = (ChatMsg)ois.readObject();	// client exit->server socketexception
				Set<String> idSet = ChatThread.user.keySet();
				Iterator <String> idIter = idSet.iterator();
				ObjectOutputStream userOut = null;
				String uid = null;
				while(idIter.hasNext()) {
					uid = idIter.next();
					userOut = user.get(uid);
					userOut.writeObject(cm);
					userOut.flush();
				}
			}
		} catch (Exception e) {
			InetAddress ia = s.getInetAddress();
			System.err.println(ia + " Client left");
			System.out.println();
			//user맵에서 퇴장한 이용자 정보 삭제
			user.remove(uid);
		} 
		System.err.println("ChatThread dead!");
	}

}
